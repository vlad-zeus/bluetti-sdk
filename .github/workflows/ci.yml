name: CI Quality Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ruff:
    name: Ruff (Lint + Format)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff lint (power_sdk + tests)
        run: ruff check power_sdk tests

      - name: Ruff format check
        run: ruff format --check power_sdk tests

  mypy:
    name: MyPy (Type Check)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: MyPy check power_sdk
        run: mypy power_sdk

  pytest:
    name: Pytest (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pytest
        run: |
          python -V
          pytest --version
          pytest -q --maxfail=5 --override-ini="addopts="
          echo "✓ All tests passed"

  runtime-validation:
    name: Runtime DSL Validation
    runs-on: ubuntu-latest
    needs: [ruff, mypy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Plugin manifest conformance tests
        run: |
          pytest tests/conformance/test_plugin_manifest_conformance.py -v
          echo "✓ All plugin manifests conform to contract"

      - name: Runtime stage resolver smoke test
        run: |
          pytest tests/unit/test_runtime_stage_resolution.py -v
          echo "✓ Stage resolver validates all pipeline stage keys"

      - name: Write gate tests
        run: |
          pytest tests/unit/test_runtime_write_gate.py -v
          echo "✓ Write gate policy matrix verified"

      - name: Validate example runtime.yaml
        run: |
          python -c "
          from power_sdk.bootstrap import load_config
          from power_sdk.runtime.config import validate_runtime_config
          cfg = load_config('examples/runtime.yaml')
          validate_runtime_config(cfg)
          print('examples/runtime.yaml: validation passed')
          "

      - name: Runtime CLI dry-run smoke test
        run: |
          python -m power_sdk runtime --config examples/runtime.yaml --dry-run
          echo "✓ runtime --dry-run passed"

      - name: Legacy API surface guard
        run: |
          # Verify no legacy symbols in user-facing docs/examples
          ! grep -rn --include="*.md" --exclude="GO-LIVE-CHECKLIST.md" "build_all_clients\|build_client_from_entry\|V2Device\|--sn\|--cert" \
            README.md docs/ examples/ || (echo "FAIL: legacy symbol in docs/examples" && exit 1)
          echo "✓ No legacy API references in docs/examples"
          # Verify no legacy re-exports sneak back into power_sdk source
          ! grep -rn --include="*.py" "build_all_clients\|V2Device" power_sdk/ \
            || (echo "FAIL: legacy symbol in power_sdk source" && exit 1)
          echo "✓ No legacy API references in power_sdk source"

      - name: Core→plugin boundary guard
        run: |
          # Core modules must NOT import from power_sdk.plugins.bluetti.*
          # Allowed path: power_sdk/contrib/bluetti.py only
          CORE_FILES="power_sdk/client.py power_sdk/client_async.py power_sdk/__init__.py power_sdk/bootstrap.py"
          for f in $CORE_FILES; do
            if grep -n "plugins\.bluetti\|from.*plugins.*bluetti" "$f"; then
              echo "FAIL: core module $f imports from plugins.bluetti" && exit 1
            fi
          done
          echo "✓ Core modules have no direct dependency on plugins.bluetti"

  # Summary job - requires all checks to pass
  quality-gate:
    name: Quality Gate (All Checks)
    runs-on: ubuntu-latest
    needs: [ruff, mypy, pytest, runtime-validation]
    steps:
      - name: All checks passed
        run: echo "✓ Quality gate passed - all checks green"
